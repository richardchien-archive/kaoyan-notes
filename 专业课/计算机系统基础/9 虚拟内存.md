# 第9章 虚拟内存

虚拟内存三个重要能力：

- 将主存看成是磁盘上的地址空间的高速缓存
- 为每个进程提供一致的地址空间
- 保护每个进程的地址空间不被其他进程破坏

## 寻址

CPU 上的内存管理单元（MMU），利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。

## 虚拟内存作为缓存工具

DRAM 缓存不命中要由磁盘来服务，因此不命中开销巨大。于是虚拟页通常很大，4KB～2MB；并且使用全相联，即任何虚拟页都可以放在任何物理页中；不命中时的替换算法也更精密复杂；最后，总是使用写回（换出时写入磁盘），而不是直写。

页表项的含义：

- 有效 && 地址非 0：CPU 完成地址翻译
- 无效 && 地址非 0：虚拟页在硬盘上，OS 换页
- 无效 && 地址是 0：未分配

局部性原则保证了在任意时刻，程序趋向于在较小的活动页面集合上工作，称为工作集或常驻集。在初始开销将工作集换入到内存中后，接下来对这个工作集的引用全部命中。

如果工作集超过了物理内存大小，会发生抖动，此时页面不断地换入换出。

## 内存映射

虚拟内存区域可以映射到两种类型的对象：

- Linux 文件系统中的普通文件：按需页面调度，在第一次引用时调入内存
- 匿名文件：直接在内存初始化一个页，而不是映射到磁盘文件

## 值得注意的题目

P575-9.4、P593-9.6、P596-9.7、书后-9.11-9.12-9.13-9.15-9.16-9.19
